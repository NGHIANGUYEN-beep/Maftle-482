<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Page Test - Maftle</title>
  <link rel="icon" type="image/png" href="/static/icon.png">
  <style>
    @font-face {
      font-family: "MinecraftFont";
      src: url("/static/MinecraftFont.woff") format("woff");
      src: url("/static/MinecraftFont.woff2") format("woff2");
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-image: url("/static/MinecraftBackground.png");
      overflow: hidden;
      margin-top: 150px;
      margin-right: 1000px;
    }
    .box {
      background-color: #C6C6C6;
      border: 2px solid black;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .grid-box {
      display: flex;
      justify-content: center;
      align-items: center;
    }
      .grid {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      grid-template-rows: repeat(3, 80px);
      gap: 5px;
      
    }

    .cell {
      border-left: 3px solid #373737;
      border-top: 3px solid #373737;
      background-color: #8B8B8B;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .items-box {
      display: flex;
      justify-content: center;
      align-items: center;
    }
      #items {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }

    .item {
      cursor: move;
    }

    .item img {
      width: 75px;
      height: 75px;
    }

    button {
      padding: 12px;
      font-size: 28px;
      font-family: "MinecraftFont";
      color: white;
      background-image: url("/static/StoneButtons.png");
      background-size: 500px;
      border-radius: 8px;
    }
    button:hover {
      filter: brightness(85%);
    }
  </style>
</head>
<body>
<div class="box grid-box">
  <div class="grid" id="grid">
    <!-- 3x3 = 9 cells -->
    <div class="cell" data-row="0" data-col="0" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="0" data-col="1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="0" data-col="2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>

    <div class="cell" data-row="1" data-col="0" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="1" data-col="1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="1" data-col="2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>

    <div class="cell" data-row="2" data-col="0" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="2" data-col="1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="cell" data-row="2" data-col="2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
  </div>
</div>

<div class="button-container">
  <button onclick="clearGrid()">Clear Table</button>
  <button onclick="submitGrid()">Submit Guess</button>
</div><br><br>

<div class="box items-box">
  <div id="items">
    <div class="item" draggable="true" ondragstart="drag(event)" data-id="coal" data-source="list" id="coal">
      <img src="/static/coal.png" draggable="false"></div>
    <div class="item" draggable="true" ondragstart="drag(event)" data-id="stick" data-source="list" id="stick">
      <img src="/static/stick.png" draggable="false"></div>
    <div class="item" draggable="true" ondragstart="drag(event)" data-id="oak_plank" data-source="list" id="oak_plank">
      <img src="/static/oak_plank.png" draggable="false"></div>
      <div class="item" draggable="true" ondragstart="drag(event)" data-id="diamond" data-source="list" id="diamond">
      <img src="/static/diamond.png" draggable="false"></div>
  </div>
</div>

<script>
function allowDrop(ev) {
  ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
  ev.dataTransfer.setData("source", ev.target.dataset.source);
  ev.dataTransfer.effectAllowed = "copyMove";
}

function drop(ev) {
  ev.preventDefault();
  const id = ev.dataTransfer.getData("text");
  const sourceType = ev.dataTransfer.getData("source");
  const original = document.getElementById(id);
  if (!original) return; // Safety check

  if (!ev.target.classList.contains('cell')) return;

  ev.target.innerHTML = '';
  let elementToAppend;

  if (sourceType === "list") {
    const clone = original.cloneNode(true);
    clone.id = original.id + "-" + Math.random().toString(36).substr(2, 5);
    clone.setAttribute("draggable", "true");
    clone.dataset.source = "grid";
    clone.ondragstart = drag;
    elementToAppend = clone;
  } else {
    elementToAppend = original;
  }

  ev.target.appendChild(elementToAppend);
}

// Clears all items inside the grid
function clearGrid() {
  const cells = document.querySelectorAll('.grid .cell');
  cells.forEach(cell => {
    cell.innerHTML = '';
  });
}

// Removes nulls from columns, preserves if null is between two items in a column
function trimNullColumns(grid) {
  if (!grid.length) return grid;

  const numCols = grid[0].length;
  let firstCol = numCols, lastCol = -1;

  for (let col = 0; col < numCols; col++) {
    const hasValue = grid.some(row => row[col] !== null);
    if (hasValue) {
      firstCol = Math.min(firstCol, col);
      lastCol = Math.max(lastCol, col);
    }
  }

  // If all columns are null, just return the original grid
  if (lastCol === -1) return grid;

  return grid.map(row => row.slice(firstCol, lastCol + 1));
}

// Removes nulls from rows, preserves if null is between two items in a row
function trimNullRows(grid) {
  const numRows = grid.length;
  let firstRow = numRows, lastRow = -1;

  for (let row = 0; row < numRows; row++) {
    const hasValue = grid[row].some(cell => cell !== null);
    if (hasValue) {
      firstRow = Math.min(firstRow, row);
      lastRow = Math.max(lastRow, row);
    }
  }

  // If all rows are null, just return the original grid
  if (lastRow === -1) return grid;

  return grid.slice(firstRow, lastRow + 1);
}

// Sends grid to backend to confirm if pattern in grid is an accepted recipe
function submitGrid() {
  const rawGrid = Array.from({ length: 3 }, () => Array(3).fill(null));

  // Going through grid, and filling out grid data array
  document.querySelectorAll('.cell').forEach(cell => {
    const row = cell.dataset.row;
    const col = cell.dataset.col;

    const item = cell.querySelector('.item');
    rawGrid[row][col] = item ? item.dataset.id : null;
  });

  // Calling functions to remove nulls
  let trimmedGrid = trimNullRows(rawGrid);
  trimmedGrid = trimNullColumns(trimmedGrid);

  // Send to server
  fetch('/submit-guess', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ grid: trimmedGrid })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('response').textContent = data.message;
  })
  .catch(err => console.error('Error:', err));
}
</script>